const util = require('../../../utils/util.js');
const api = require('../../../utils/api.js');
const App = getApp();
Page({
  data: {
    qualityList: [], //品质范围
    adapter: "", //适用机型
    adapterDetail:null,
    prodImages:'',
    show:false,
    
    parts: [], //配件
    photoList: [], //临时照片路径

    qualitificateLimit: "", //选中后的品质

    original: [], //上传后的返回的图片路径
    isComplete: false, //图片是否上传完毕
    updataImg: [], //询价失败、已过期、已退回的图片上传
    submit_limit: false, //限制只能提交一次,以免重复点击时候会发布多条询价单
  },
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function(options) {
    this.getList()
  },

  clickModal(){
    this.setData({
      show:false
    })
    util.reloadBfeorePage()
  },

  onShow(){
    const userInfo = util.getStorageSync('userInfo')
    const registerInfo = util.getStorageSync('registerInfo')
    if (!userInfo) {
      wx.showModal({
        content: '您还没有登陆',
        success: function (e) {
          if (e.confirm) {
            wx.navigateTo({
              url: '/pages/login/login',
            })
          } else {
            wx.switchTab({
              url: '/pages/index/inqueryRoom/inqueryRoom'
            })
          }
        }
      })
    }
  },

  getList(){
    util.request(api.list2).then(res => {
      console.log(res.data)
      if(res.data){
        let arr = []
        res.data.forEach(a => {
          arr.push(a.name)
        })
        this.setData({
          qualitificateLimit:arr.join(',')
        })
      }
      this.setData({
        qualityList:res.data
      })
    })
  },

  /**
   * 生命周期函数--监听页面隐藏
  //  */
  onUnload: function() {
    let pages = getCurrentPages()
    let prevPage = pages[pages.length - 2]
    prevPage.setData({
      flag: true
    })
  },
  checkboxChange: function(e) {
    this.setData({
      qualitificateLimit: e.detail.value.join(",")
    });
  },
  // 删除配件列表
  delItem(e) {
    var that = this
    var index = e.currentTarget.dataset.index
    wx.showModal({
      title: '确定删除配件？',
      content: "",
      confirmColor: "#f05b29",
      success: function(res) {
        if (res.confirm) {
          that.data.parts.splice(index, 1)
          that.setData({
            parts: that.data.parts
          });
        }
      }
    })

  },
  // 适用机型
  searchType() {
    var partName = this.data.adapter
    wx.navigateTo({
      url: `/pages/index/makeInquriy/searchType/searchType?title=适用机型&partName=${partName}`,

    })
  },
  // 编辑配件名称
  editPartName(e) {
    var index = e.currentTarget.dataset.index;
    console.log(index);
    var item = e.currentTarget.dataset.item;
    wx.navigateTo({
      url: `/pages/index/makeInquriy/searchType/searchType?title=配件名称&partName=${item.name}&index=${index}&isEdit=1`,
    })
  },
  //配件名称
  goName() {
    wx.navigateTo({
      url: '/pages/index/makeInquriy/searchType/searchType?title=配件名称',
    })
  },

  editN(e) {
    let value = e.detail.value
    let index = e.currentTarget.dataset.index
    let name = e.currentTarget.dataset.name
    let centerValue = this.data.parts
    centerValue[index][name] = value
    this.setData({
      parts: centerValue
    });
  },
  // 删除照片
  del: function(e) {
    let that = this;
    let index = e.currentTarget.dataset.index;
    this.data.photoList.splice(index, 1);
    this.setData({
      photoList: that.data.photoList
    })
  },
  // 添加照片
  add: function() {
    var self = this;
    wx.chooseImage({
      count: 9 - self.data.photoList.length, // 默认9
      sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
      sourceType: ['album', 'camera'],
      success: function(res) {
        let photoList = self.data.photoList;
        photoList = photoList.concat(res.tempFilePaths);
        // 编辑询价单（询价失败、已过期、已退回、），所需上传的新图片。
        var updataImg = self.data.updataImg;
        updataImg = updataImg.concat(res.tempFilePaths);
        // 编辑询价单（询价失败、已过期、已退回、），所需上传的新图片。
        self.setData({
          photoList,
          updataImg
        })
      }
    })
  },
  submitInfo(){
    let params = {

    }
    const {
      photoList,
      prodImages,
      isComplete
    } = this.data

    if (!isComplete) {
      if (photoList.length) {
        util.uploadFileGroup(photoList).then(res => {
          this.setData({
            prodImages: res,
            isComplete: true
          })
          params.prodImages = res
          this.submitCertain(params)
        })
      } else {
        this.submitCertain(params)
      }
    } else {
      this.submitCertain(params)
    }
  },
  // 发布询价
  submitCertain(obj) {
    const { 
      isComplete, 
      submit_limit, 
      parts, 
      qualitificateLimit, 
      photoList,
      prodImages,
      adapter,
      adapterDetail
      } = this.data
    const userInfo = util.getStorageSync('userInfo')
    const registerInfo = util.getStorageSync('registerInfo')
    
    if (submit_limit) return
    if (!adapter) {
      this.showModal("适用机型不能为空")
      return
    } else if (parts.length == 0) {
      this.showModal("配件不能为空")
      return
    } else if (!qualitificateLimit) {
      this.showModal("品质范围不能为空")
      return
    }
    let params ={}


    let items = []
    parts.forEach(item => {
      items.push({
        prodName:item.name,
        prodNum:item.num
      })
    })
    params ={
      ...params,
      ...obj,
      createUser: userInfo.userId,
      providerId: registerInfo.providerId,
      qualitificateLimit,
      tenantId: App.globalData.tenantId,
      items
    }
    if (adapterDetail.id){
      params.model = adapterDetail.id
      params.modelName = adapterDetail.name
    } else {
      params.modelName = adapterDetail
    }
    this.setData({
      submit_limit: true
    })
    wx.showLoading({
      title: '正在提交...',
    })
    util.request(api.publishP, params,'POST').then(res => {
      console.log(res)
      if(res.success){
        this.showModal('提交成功')
      }
      wx.hideLoading()
      this.setData({
        show:true
      })
      setTimeout(function(){
        // const id = e.currentTarget.dataset.id
        // const type = e.currentTarget.dataset.type
        // wx.navigateTo({
        //   url: `/pages/index/inqueryRoom/inqueryOrderDetail/inqueryOrderDetail?id=${id}&type=${type}`
        // })

        // wx.switchTab({
        //   url: '/pages/index/inqueryRoom/inqueryRoom'
        // })
      },800)
    })
  },
  showModal(message){
    wx.showToast({
      title: message,
      icon: "none"
    })
  }
})