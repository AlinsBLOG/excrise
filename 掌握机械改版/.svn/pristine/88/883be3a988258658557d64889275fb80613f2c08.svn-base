const App = getApp();
const util = require('../../../utils/util.js');
const api = require('../../../utils/api.js');
var scroll = 0;
Page({
  data: {
    serchinput: '',
    moreList: [],
    pageNo:1,
    loadMore:true,
    
    origin: 0,
    style: true,
    fix: false,
    lastY: '',
    showMore: null,
    page: 1,
    list: {},
    selectValue: 1,
    
    showReturn: false,
    isShow: false,
  },
  onLoad: function(options) {
    const serchinput = options.serchinput
    this.setData({
      serchinput: serchinput || ''
    })
    this.getGoodsList()
  },

  confirm(e){
    const serchinput = e.detail.value
    this.setData({
      serchinput,
      moreList:[],
      loadMore:true,
      pageNo:1
    })
    this.getGoodsList()
  },

  // 获取搜索商品列表
  getGoodsList() {
    let that = this
    let { serchinput, moreList, loadMore, pageNo } = this.data
    let data = {
      pageNo
    }
    if (serchinput) data.nameLike = serchinput
    if (loadMore) {
      wx.showLoading({
        title: '正在加载...',
      })
      util.request(api.getProduct, data,'POST').then(res => {
        console.log(res.data)
        if (pageNo >= res.pageCount) {
          this.setData({
            loadMore: false
          })
        }
        if (res.data) {
          let centerVal = res.data
          moreList = moreList.concat(centerVal)
        }
        this.setData({
          moreList,
          pageNo: pageNo + 1
        })
        wx.hideLoading()
      })
    }
  },
  // 切换样式
  changeStyle: function() {
    this.setData({
      style: !this.data.style
    })
  },
  // 跳转到搜索
  toSearch: function() {
    if (this.data.serchinput != '') {
      wx.navigateBack({ //返回
        delta: 1
      })
    } else {
      var serchinput = this.data.serchinput
      var pages = getCurrentPages(); //当前页面
      var prevPage = pages[pages.length - 2]; //上一页面
      prevPage.setData({ //直接给上移页面赋值
        serchinput
      });
      wx.navigateTo({
        url: '/pages/index/search/search',
      })
    }
  },
  // 人气
  select1: function() {
    if (this.data.selectValue != 1) {
      this.setData({
        showMore: 0,
        page: 1,
        selectValue: 1
      });
      this.getGoodsList();
    }
  },
  // 联系
  select2: function() {
    if (this.data.selectValue != 2) {
      this.setData({
        showMore: 0,
        page: 1,
        selectValue: 2
      });
      this.getGoodsList();
    }
  },
  // 新品
  select3: function() {
    if (this.data.selectValue != 3) {
      this.setData({
        showMore: 0,
        page: 1,
        selectValue: 3
      });
      this.getGoodsList();
    }
  },
  // 价格
  select45: function() {
    var selectValue = this.data.selectValue == 5 ? 4 : 5;
    this.setData({
      showMore: 0,
      page: 1,
      selectValue: selectValue
    });
    this.getGoodsList();
  },
  // 关闭蒙版
  closeMask: function() {
    this.setData({
      filValue: 0,
      isScroll: true
    })
  },
  // 适用机型
  filtrate1: function() {
    if (this.data.filValue != 1) {
      this.setData({
        showMore: 0,
        page: 1,
        filValue: 1
      });
      this.selectClass();
      setTimeout(() => {
        this.closeMask()
      }, 1000);
    }
  },
  // 产品类型
  filtrate2: function() {
    if (this.data.filValue != 2) {
      this.setData({
        isScroll: false,
        showMore: 0,
        page: 1,
        filValue: 2
      });
    }
  },

  // 货源
  filtrate3: function() {
    if (this.data.filValue != 3) {
      this.setData({
        isScroll: false,
        showMore: 0,
        page: 1,
        filValue: 3
      });
    }
  },
  // 选择机型
  selectClass: function() {
    var serchinput = this.data.serchinput
    wx.navigateTo({
      url: '/pages/index/selClass/selClass?serchinput=' + serchinput
    });
  },
  // 改变货源
  changeOrigin: function(e) {

    var origin = e.target.id;
    this.setData({
      origin
    })
    this.getGoodsList2();
    this.changeName3(e);
  },
  // 获得下一级类型
  getNextType: function(e) {
    var that = this;
    var nextType = e.target.id;
    var nextName = e.target.dataset.text;
    this.setData({
      nextType,
      nextName
    })
    var data = {
      pid: nextType,
      only_list: 1
    }
    App.request(
      'index/alltype_more',
      'POST',
      data,
      function(res) {
        that.setData({
          nextTypeList: res.data.data.type_list
        })

        if (nextType == 0) {
          that.changeType(e)
        }
      }
    )
  },
  // 改变类型
  changeType: function(e) {
    var lastType = e.target.id;
    this.setData({
      type: lastType
    })
    this.getGoodsList2();
    this.changeName2(e);
  },
  // 改变框内名字
  changeName2: function(e) {
    var name2 = e.target.dataset.text;
    if (name2 == "全部类型") {
      name2 = this.data.nextName
    }
    if (name2.length > 4) {
      var word = name2.substring(0, 3) + "...";
      name2 = word;
    }
    this.setData({
      name2
    })
  },
  changeName3: function(e) {
    this.setData({
      name3: e.target.dataset.text
    })
  },

  // 获取商品ID跳转到详情
  goDetails: function(e) {
    var id = e.currentTarget.dataset.text.id;
    var goods_id = e.currentTarget.dataset.text.goods_id;
    this.setData({
      isShow: true, //
    });
    wx.navigateTo({
      url: '/pages/index/details/details?id=' + id + '&goods_id=' + goods_id
    });
  },
  // 返回顶部
  returnTop: function() {
    this.setData({
      scrollTop: 0,
      showReturn: false
    });
  },
  goInquiry() {
    // App.globalData.activeId = this.data.inquiryDetails.id;
    // App.globalData.status_name = this.data.inquiryDetails.status_name;
    console.log("跳转发布询价");
    wx.navigateTo({
      url: '/pages/index/inqueryRoom/inqueryOrderDetail/reInquery/reInquery',
    })
    // wx.switchTab({
    //     url: '/pages/inqueryTab/inqueryTab',
    // })
  },
})