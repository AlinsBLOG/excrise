const util = require('../../../../../../utils/util.js');
const api = require('../../../../../../utils/api.js');
const App = getApp();
Page({
  /**
   * 页面的初始数据
   */
  data: {
    show:false,
    company:'',
    address: "",
    area:null,
    region:[],
    isPicker: false,
    createUser:null,
    mobile: "",
    tenantId:null,
    type:'MTS',

    upload_yingyeImg: [], //营业执照图片
    logoImages: [], //公司照片
    business: [], //上传营业执照后服务器返回的路径
    doorhead: [], //上传公司照片后服务器返回的路径
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function(options) {
    const identity = options.title || 2
    const createUser = util.getStorageSync('userInfo').userId
    let name = ''
    let type = 'MTS'
    if (identity == 1){
      name = '修理厂'
    } else {
      name = '公司'
      type = 'TPS'
    }
    var title = name + "认证"
    var name_placeholder = `请输入${name}名称`
    var detail_placeholder = `请输入${name}详细地址`
    var area_placeholder = `请输入${name}所在地区`
    wx.setNavigationBarTitle({
      title: title,
    })
    this.setData({
      identity,
      createUser,
      name_placeholder,
      detail_placeholder,
      area_placeholder,
      type
    });
  },

  bindRegionChange: function (e) {
    this.setData({
      region: e.detail.value,
      isPicker: true,
      area: e.detail.code[2]
    })
  },

  chooseLocation: function () {
    App.chooseLocation(this)
    // console.log(this.data)
  },

  certain(e){
    const region = e.detail
    this.setData({
      region,
      show:false
    })
  },
  // 定位
  // chooseLocation: function() {
  //   this.setData({
  //     show:true
  //   })
  // },
  formValidate(e) {
    const { upload_yingyeImg, logoImages, area, identity } = this.data
    console.log(upload_yingyeImg, logoImages)
    let that = this
    const token = util.getStorageSync('registerInfo').token
    let data = {
      company: e.detail.value.company,
      address: e.detail.value.address,
      linkMan: e.detail.value.linkMan,
      mobile: e.detail.value.mobile,
      area,
      createUser: this.data.createUser,
      tenantId: App.globalData.tenantId,
      type: this.data.type,
      licenseImage:'',
      logoImage:''
    }
    if (util.checkPhoneNum(data.mobile)){
      // console.log(data)
      if (!data.company){
        util.showErrorToast('请填写公司名称')
        return
      } else if (!data.address) {
        util.showErrorToast('请填写地址')
        return
      } else if (!data.linkMan) {
        util.showErrorToast('请填写联系人')
        return
      } else if (!data.area) {
        util.showErrorToast('请选择地区')
        return
      } else if (!logoImages.length) {
        util.showErrorToast('请上传公司照片')
        return
      }

      if (identity == 2){
        if (!upload_yingyeImg.length) {
          util.showErrorToast('请上传营业执照')
          return
        } 
      }
      wx.showLoading({
        title: '正在提交',
      })

      util.uploadFileGroup(logoImages).then(resCom => {
        data.logoImage = resCom
        if (identity == 2){
          util.uploadFileGroup(upload_yingyeImg).then(resLo => {
            data.licenseImage = resLo
            console.log(data)
            that.save(data)
          })
        } else {
          that.save(data)
          console.log(data)
        }
      })
    }
  },
  save(data){
    util.request(api.authorize, data, 'POST').then(resLast => {
      if (resLast.success) {
        wx.hideLoading()
        wx.showToast({
          title: '提交成功',
        })
        setTimeout(function () {
          wx.redirectTo({
            url: '/pages/index/inqueryRoom/inqueryOrderDetail/businessAuth/authForm/examine/examine',
          })
        }, 700)
      }
    })
  },
  // 营业执照上传
  upload_yingye: function(e) {
    var self = this;
    wx.chooseImage({
      count: 1, // 默认9
      sizeType: ['original', 'compressed'],
      sourceType: ['album', 'camera'],
      success: function(res) {
        self.setData({
          upload_yingyeImg: res.tempFilePaths,
        });
      }
    })
  },
  // 营业执照删除
  del_upload_yingyeImg() {
    var that = this;
    this.setData({
      upload_yingyeImg: [],
    });
  },
  // 公司照片上传
  upload_comp: function() {
    var self = this;
    wx.chooseImage({
      count: 3 - self.data.logoImages.length, 
      sizeType: ['original', 'compressed'], 
      sourceType: ['album', 'camera'],
      success: function(res) {
        let logoImages = self.data.logoImages;
        logoImages = logoImages.concat(res.tempFilePaths);
        self.setData({
          logoImages
        });
      }
    })
  },
  // 删除公司照片
  del_comp_img(e) {
    let self = this;
    let index = e.currentTarget.dataset.index;
    this.data.logoImages.splice(index, 1);
    this.setData({
      logoImages: self.data.logoImages
    })
  }
})