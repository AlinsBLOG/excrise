<template>
  <div class="Home">
    <Head-Top :head-title="title + '项目'" go-back='true'></Head-Top>
    <div class="sponsor">
      <mt-field label="项目名称" placeholder="项目名称" type="text" class='required' v-model='bean.title'></mt-field>
      <mt-field label="发起人" placeholder="发起人" type="text" class='required' v-model='bean.createUser'></mt-field>
      <mt-field label="发起部门" placeholder="发起部门" type="text" v-model='bean.department'></mt-field>
      <mt-field label="项目金额" placeholder="项目金额" type="number" v-model='bean.price'>
        <mt-button type="primary" size='small'>元</mt-button>
      </mt-field>
      <mt-field label="项目有效期" placeholder="项目有效期" type="number" v-model='bean.expiryDate'>
        <mt-button type="primary" size='small'>个月</mt-button>
      </mt-field>
      <mt-field label="项目起始时间" placeholder="项目起始时间" type='date' v-model='bean.beginDate'></mt-field>
      <mt-field label="项目结束时间" placeholder="项目结束时间" type='date' v-model='bean.endDate'></mt-field>
      <mt-field label="项目背景" placeholder="项目背景" type="textarea" rows="4" v-model='bean.background'></mt-field>
      <mt-field label="项目需求" placeholder="项目需求" type="textarea" rows="4" v-model='bean.description'></mt-field>
      <mt-field label="交付成果" placeholder="交付成果" type="textarea" rows="4" v-model='bean.result'></mt-field>
      <mt-button type="primary" size="large" class="login-btn" @click.native="submit">确认{{title}}</mt-button>
    </div>
  </div>
</template>

<script>
import { mapState, mapMutations, mapGetters  } from 'vuex'
import  { Toast } from "mint-ui"
import HeadTop from '@/components/header/head'
import { projectCreate, projectModify, projectgetInfo } from '@/service/getData'

export default {
  name: "Sponsor",
  data () {
    return{
      title: '发起',
      id: null,
      bean: {
        title: '',
        createUser: '',
        department: '',
        price: '',
        expiryDate: '',
        beginDate: '',
        endDate: '',
        background: '',
        description: '',
        result: '',
        tenantId: 1,
        classId: 1,
        openType: 1,
      }
    }
  },
  components: {
    HeadTop
  },
  mounted: function () {
    const id = this.$route.query.id
    if (id) {
      this.id = id
      this.title = '编辑'
      this.getInfo(id)
    }
  },
  computed: {
    ...mapState([
        'userInfo'
    ]),
  },
  methods:{
    ...mapMutations(['SET_USERINFO','SET_LOADING']),
    // 成功发布需求
    async submit () {
      const that = this
      if (!that.bean.createUser || !that.bean.title) {
        Toast('项目名称或项目发起人不能为空')
        return
      }
      that.SET_LOADING(true)
      if (that.id) {
        await projectModify({
          ...this.bean,
        }).then( res => {
          if (res.success) {
            that.SET_LOADING(false)
            Toast('编辑项目成功')
          }
        })
      } else {
        await projectCreate({
          ...this.bean,
          // id: that.userInfo.id
        }).then( res => {
          if (res.success) {
            that.SET_LOADING(false)
            that.$router.push({
              path:'/project/sponsorSuccess'
            })
          }
        })
      }
    },

    async getInfo (id) {
      this.SET_LOADING(true)
      await projectgetInfo(id).then(res => {
        if (true) {
          this.bean = res.data
        }
        this.SET_LOADING(false)
      })
    },
  }
}
</script>

<style lang="scss" scoped>
  .sponsor {
    margin-top: .1rem;
    .login-btn {
      margin: .5rem auto 0;
    }
  }
</style>

